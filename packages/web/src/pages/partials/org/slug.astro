---
import { fn } from "@paperwait/core/valibot";
import * as v from "valibot";

import { isOrgSlugValid } from "~/api/lib/organization";
import OrgSlug from "~/components/org/slug.astro";
import { Registration } from "~/shared/lib/schemas";

import type { OrgSlugProps } from "~/components/props";

export const partial = true;

const formData = await Astro.request.formData();

const getProps = fn(
  v.fallback(v.object({ slug: Registration.entries.slug }), { slug: "" }),
  async ({ slug }): Promise<OrgSlugProps> => {
    if (!slug) return { value: "" };

    const isValid = await isOrgSlugValid(slug);

    return { value: slug, isValid };
  },
);

const props = await getProps(Object.fromEntries(formData.entries()));
---

<OrgSlug {...props} />
