---
import { HttpError } from "@paperwait/core/errors";
import { healthCheck } from "@paperwait/core/papercut";
import { NanoId } from "@paperwait/core/schemas";
import { validate } from "@paperwait/core/valibot";
import * as v from "valibot";

import PapercutHealthCheck from "~/components/papercut/health-check.astro";

import type { PapercutHealthCheckProps } from "~/components/props";

export const partial = true;

const formData = await Astro.request.formData();

const { orgId, authToken } = validate(
  v.object({ orgId: NanoId, authToken: v.string() }),
  Object.fromEntries(formData.entries()),
);

let props: PapercutHealthCheckProps;
try {
  await healthCheck({ orgId, input: { authorized: false, authToken } });
  props = { status: "success" };
} catch (e) {
  props = {
    status: "error",
    reason: e instanceof HttpError ? e.message : "An unexpected error occurred",
  };
}
---

<PapercutHealthCheck {...props} />
